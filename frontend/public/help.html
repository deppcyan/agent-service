<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作流节点文档</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            color: #2c3e50;
            margin-top: 25px;
        }
        h4 {
            color: #7f8c8d;
            margin-top: 20px;
        }
        code {
            background-color: #f1f2f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            color: #e74c3c;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            line-height: 1.2;
            font-size: 12px;
        }
        pre code {
            background: none;
            color: #ecf0f1;
            padding: 0;
            line-height: 1.2;
            font-size: 12px;
        }
        /* 代码块中的注释样式 */
        pre .comment {
            color: #95a5a6;
            font-style: italic;
        }
        ul, ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
        strong {
            color: #2c3e50;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            background-color: #fdf2f2;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
        }
        .toc {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        .toc h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .toc ul {
            margin: 10px 0;
        }
        .toc a {
            color: #3498db;
            text-decoration: none;
        }
        .toc a:hover {
            text-decoration: underline;
        }
        .download-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.3s;
            margin-left: 20px;
            vertical-align: middle;
        }
        .download-btn:hover {
            background-color: #2980b9;
        }
        .download-btn svg {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="content" class="loading">
            正在加载文档...
        </div>
    </div>

    <script>
        // 简单的markdown渲染函数
        function renderMarkdown(markdown) {
            // 先保护代码块，避免其中的内容被误处理
            const codeBlocks = [];
            let codeBlockIndex = 0;
            
            // 提取并保护代码块
            markdown = markdown.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
                const placeholder = `__CODE_BLOCK_${codeBlockIndex}__`;
                // 高亮注释
                const highlightedCode = code.replace(/(#.*$)/gm, '<span class="comment">$1</span>');
                codeBlocks[codeBlockIndex] = '<pre><code>' + highlightedCode + '</code></pre>';
                codeBlockIndex++;
                return placeholder;
            });
            
            // 处理其他markdown语法
            markdown = markdown
                // 标题（现在不会误处理代码块中的#）
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^#### (.*$)/gim, '<h4>$1</h4>')
                
                // 行内代码
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                
                // 粗体
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                
                // 列表项
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                
                // 包装列表
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                
                // 段落
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(?!<[h|u|p|d])/gm, '<p>')
                .replace(/$(?!<\/[h|u|p|d])/gm, '</p>')
                
                // 清理多余的p标签
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<[h|u])/g, '$1')
                .replace(/(<\/[h|u]>)<\/p>/g, '$1');
            
            // 恢复代码块
            for (let i = 0; i < codeBlocks.length; i++) {
                markdown = markdown.replace(`__CODE_BLOCK_${i}__`, codeBlocks[i]);
            }
            
            return markdown;
        }

        // 存储原始markdown内容
        let originalMarkdown = '';

        // 加载markdown文件
        fetch('/workflow_nodes_documentation.md')
            .then(response => {
                if (!response.ok) {
                    throw new Error('无法加载文档文件');
                }
                return response.text();
            })
            .then(markdown => {
                originalMarkdown = markdown; // 保存原始内容
                const contentDiv = document.getElementById('content');
                contentDiv.innerHTML = renderMarkdown(markdown);
                contentDiv.className = '';
                
                // 添加目录导航
                addTableOfContents();
                
                // 添加下载按钮到主标题旁边
                addDownloadButton();
            })
            .catch(error => {
                document.getElementById('content').innerHTML = 
                    '<div class="error">加载文档时出错: ' + error.message + '</div>';
            });

        // 添加目录
        function addTableOfContents() {
            const headings = document.querySelectorAll('h1, h2, h3');
            if (headings.length === 0) return;

            const toc = document.createElement('div');
            toc.className = 'toc';
            toc.innerHTML = '<h3>目录</h3><ul></ul>';
            
            const tocList = toc.querySelector('ul');
            
            headings.forEach((heading, index) => {
                const id = 'heading-' + index;
                heading.id = id;
                
                const li = document.createElement('li');
                li.style.marginLeft = (parseInt(heading.tagName.charAt(1)) - 1) * 20 + 'px';
                
                const a = document.createElement('a');
                a.href = '#' + id;
                a.textContent = heading.textContent;
                
                li.appendChild(a);
                tocList.appendChild(li);
            });
            
            // 在第一个h1后插入目录
            const firstH1 = document.querySelector('h1');
            if (firstH1) {
                firstH1.parentNode.insertBefore(toc, firstH1.nextSibling);
            }
        }

        // 添加下载按钮到主标题旁边
        function addDownloadButton() {
            const firstH1 = document.querySelector('h1');
            if (!firstH1) return;

            // 创建下载按钮
            const downloadBtn = document.createElement('button');
            downloadBtn.id = 'downloadBtn';
            downloadBtn.className = 'download-btn';
            downloadBtn.title = '下载文档到本地';
            downloadBtn.innerHTML = `
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                下载文档
            `;

            // 将按钮添加到主标题后面
            firstH1.appendChild(downloadBtn);
            
            // 绑定点击事件
            downloadBtn.addEventListener('click', downloadMarkdown);
        }

        // 下载功能
        function downloadMarkdown() {
            if (!originalMarkdown) {
                alert('文档还未加载完成，请稍后再试');
                return;
            }

            // 创建Blob对象
            const blob = new Blob([originalMarkdown], { type: 'text/markdown;charset=utf-8' });
            
            // 创建下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'workflow_nodes_documentation.md';
            
            // 触发下载
            document.body.appendChild(a);
            a.click();
            
            // 清理
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
